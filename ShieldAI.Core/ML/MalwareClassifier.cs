using Microsoft.ML;
using ShieldAI.Core.Models;

namespace ShieldAI.Core.ML;

/// <summary>
/// مصنف البرمجيات الخبيثة باستخدام ML.NET
/// يستخدم نموذج FastTree للتصنيف الثنائي
/// </summary>
public class MalwareClassifier
{
    private readonly MLContext _mlContext;
    private readonly FeatureExtractor _featureExtractor;
    private ITransformer? _model;
    private PredictionEngine<MalwareFeatures, MalwarePrediction>? _predictionEngine;
    
    // مسار حفظ النموذج
    private readonly string _modelPath;

    public MalwareClassifier(string? modelPath = null)
    {
        _mlContext = new MLContext(seed: 42);
        _featureExtractor = new FeatureExtractor();
        
        // مسار النموذج الافتراضي
        _modelPath = modelPath ?? Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData),
            "ShieldAI", "Models", "malware_model.zip");
        
        // محاولة تحميل النموذج إن وُجد
        LoadModel();
    }

    /// <summary>
    /// تحميل النموذج المُدرّب
    /// </summary>
    public bool LoadModel()
    {
        try
        {
            if (File.Exists(_modelPath))
            {
                _model = _mlContext.Model.Load(_modelPath, out _);
                _predictionEngine = _mlContext.Model.CreatePredictionEngine<MalwareFeatures, MalwarePrediction>(_model);
                return true;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load model: {ex.Message}");
        }
        
        return false;
    }

    /// <summary>
    /// تدريب النموذج على بيانات
    /// </summary>
    public void Train(IEnumerable<MalwareFeatures> trainingData)
    {
        var dataView = _mlContext.Data.LoadFromEnumerable(trainingData);

        // تعريف خط الأنابيب
        var pipeline = _mlContext.Transforms
            // دمج الخصائص في عمود واحد
            .Concatenate("Features",
                nameof(MalwareFeatures.FileSize),
                nameof(MalwareFeatures.SectionCount),
                nameof(MalwareFeatures.Entropy),
                nameof(MalwareFeatures.ImportedDllCount),
                nameof(MalwareFeatures.SuspiciousDllCount),
                nameof(MalwareFeatures.DangerousApiCount),
                nameof(MalwareFeatures.HasDigitalSignature),
                nameof(MalwareFeatures.IsDll),
                nameof(MalwareFeatures.Is64Bit),
                nameof(MalwareFeatures.CodeRatio))
            // تطبيع البيانات
            .Append(_mlContext.Transforms.NormalizeMinMax("Features"))
            // خوارزمية التصنيف
            .Append(_mlContext.BinaryClassification.Trainers.FastTree(
                labelColumnName: "Label",
                featureColumnName: "Features",
                numberOfTrees: 100,
                numberOfLeaves: 50,
                minimumExampleCountPerLeaf: 10));

        // تدريب النموذج
        _model = pipeline.Fit(dataView);
        _predictionEngine = _mlContext.Model.CreatePredictionEngine<MalwareFeatures, MalwarePrediction>(_model);
    }

    /// <summary>
    /// حفظ النموذج المُدرّب
    /// </summary>
    public void SaveModel()
    {
        if (_model == null)
            throw new InvalidOperationException("No model to save. Train the model first.");

        var directory = Path.GetDirectoryName(_modelPath);
        if (!string.IsNullOrEmpty(directory) && !Directory.Exists(directory))
        {
            Directory.CreateDirectory(directory);
        }

        _mlContext.Model.Save(_model, null, _modelPath);
    }

    /// <summary>
    /// التنبؤ بطبيعة ملف
    /// </summary>
    public MalwarePrediction Predict(string filePath)
    {
        var features = _featureExtractor.ExtractFeatures(filePath);
        return Predict(features);
    }

    /// <summary>
    /// التنبؤ بناءً على الخصائص
    /// </summary>
    public MalwarePrediction Predict(MalwareFeatures features)
    {
        // إذا لم يكن هناك نموذج مُدرّب، نستخدم القواعد الثابتة
        if (_predictionEngine == null)
        {
            return PredictWithRules(features);
        }

        return _predictionEngine.Predict(features);
    }

    /// <summary>
    /// التنبؤ باستخدام القواعد الثابتة (بدون نموذج)
    /// </summary>
    private MalwarePrediction PredictWithRules(MalwareFeatures features)
    {
        var riskScore = _featureExtractor.CalculateRiskScore(features);
        
        return new MalwarePrediction
        {
            IsMalware = riskScore > 0.5f,
            Probability = riskScore,
            Score = riskScore
        };
    }

    /// <summary>
    /// تقييم النموذج
    /// </summary>
    public Microsoft.ML.Data.CalibratedBinaryClassificationMetrics? Evaluate(IEnumerable<MalwareFeatures> testData)
    {
        if (_model == null)
            return null;

        var dataView = _mlContext.Data.LoadFromEnumerable(testData);
        var predictions = _model.Transform(dataView);
        
        return _mlContext.BinaryClassification.Evaluate(predictions, "Label");
    }

    /// <summary>
    /// توليد بيانات تدريب تجريبية
    /// </summary>
    public static List<MalwareFeatures> GenerateSampleTrainingData()
    {
        var data = new List<MalwareFeatures>();
        var random = new Random(42);

        // بيانات ملفات آمنة (نموذجية)
        for (int i = 0; i < 100; i++)
        {
            data.Add(new MalwareFeatures
            {
                FileSize = random.Next(50, 5000),
                SectionCount = random.Next(4, 7),
                Entropy = (float)(random.NextDouble() * 2 + 4), // 4-6
                ImportedDllCount = random.Next(5, 20),
                SuspiciousDllCount = random.Next(0, 2),
                DangerousApiCount = random.Next(0, 3),
                HasDigitalSignature = random.NextDouble() > 0.3 ? 1 : 0, // 70% موقعة
                IsDll = random.NextDouble() > 0.7 ? 1 : 0,
                Is64Bit = random.NextDouble() > 0.4 ? 1 : 0,
                CodeRatio = (float)(random.NextDouble() * 0.3 + 0.2), // 0.2-0.5
                IsMalware = false
            });
        }

        // بيانات ملفات خبيثة (نموذجية)
        for (int i = 0; i < 100; i++)
        {
            data.Add(new MalwareFeatures
            {
                FileSize = random.Next(10, 2000),
                SectionCount = random.Next(2, 12),
                Entropy = (float)(random.NextDouble() * 1.5 + 6.5), // 6.5-8
                ImportedDllCount = random.Next(3, 15),
                SuspiciousDllCount = random.Next(3, 7),
                DangerousApiCount = random.Next(5, 15),
                HasDigitalSignature = random.NextDouble() > 0.9 ? 1 : 0, // 10% موقعة
                IsDll = random.NextDouble() > 0.5 ? 1 : 0,
                Is64Bit = random.NextDouble() > 0.5 ? 1 : 0,
                CodeRatio = (float)(random.NextDouble() * 0.2 + 0.1), // 0.1-0.3
                IsMalware = true
            });
        }

        return data;
    }

    /// <summary>
    /// هل النموذج محمّل وجاهز
    /// </summary>
    public bool IsModelLoaded => _predictionEngine != null;
}

